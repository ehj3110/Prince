# Autolog Metrics CSV Export Feature

**Date**: October 2, 2025  
**Status**: ✅ Implemented and Tested

## Overview

Added automatic CSV export functionality to save adhesion metrics from autolog file analysis in the same format as the live `automated_work_of_adhesion.csv` file generated by PeakForceLogger, with an additional **Speed** column.

## Implementation Details

### 1. CSV Output Format

The generated `autolog_metrics.csv` file contains the following columns:

| Column | Description | Units | Source |
|--------|-------------|-------|--------|
| Layer_Number | Layer number from filename | - | Extracted from autolog filename |
| Speed_um_s | Step speed for this layer | µm/s | From instruction file (if available) |
| Peak_Force_N | Maximum adhesion force | N | `peak_force` |
| Work_of_Adhesion_mJ | Corrected work of adhesion | mJ | `work_of_adhesion_corrected_mJ` |
| Initiation_Time_s | Pre-initiation start time | s | `pre_initiation_time` |
| Propagation_End_Time_s | Propagation end time | s | `propagation_end_time` |
| Total_Peel_Duration_s | Total peel duration | s | `total_peel_duration` |
| Distance_to_Peak_mm | Pre-initiation distance | mm | `pre_initiation_distance` |
| Propagation_Distance_mm | **CORRECTED** propagation distance | mm | `propagation_distance` |
| Total_Peel_Distance_mm | Total peel distance | mm | `total_peel_distance` |
| Peak_Retraction_Force_N | Minimum (negative) force | N | Calculated from raw data |
| Peak_Position_mm | Stage position at peak | mm | `peak_force_position` |
| Propagation_Start_Time_s | Time at peak force | s | `peak_force_time` |
| Propagation_Duration_s | **CORRECTED** propagation duration | s | `propagation_duration` |

### 2. Critical Fix: Propagation Metrics

**Problem Identified**: The original PeakForceLogger incorrectly calculated propagation distance and time by using the *remaining distance/time in the lifting step* rather than measuring from peak to propagation end.

**Solution**: The RawData_Processor uses the correct values from AdhesionMetricsCalculator:
- `propagation_distance = positions[prop_end_idx] - positions[peak_idx]`
- `propagation_duration = times[prop_end_idx] - times[peak_idx]`

This measures the **actual crack propagation phase** (from peak force until baseline is reached), not the entire lift motion.

### 3. Files Modified

#### `post-processing/RawData_Processor.py`
- Added `csv` import
- Added `export_metrics_to_csv()` method
  - Creates CSV with PeakForceLogger-compatible format
  - Includes Speed column (2nd column)
  - Uses **correct** propagation metrics from calculator
  - Accepts optional `layer_speeds` dict for speed values

#### `post-processing/run_full_analysis.py`
- Calls `export_metrics_to_csv()` after processing
- Saves to `autolog_metrics.csv` in same folder as input file

#### `post-processing/batch_v17_analysis.py`
- Calls `export_metrics_to_csv()` after processing each folder
- Passes `layer_speeds` dict from instruction file
- Saves to `autolog_metrics.csv` in each test folder

### 4. Usage

#### Single File Analysis
```bash
python run_full_analysis.py "path/to/autolog_L110-L114.csv"
```
**Output**:
- `autolog_L110-L114_analysis.png` (plot)
- `autolog_metrics.csv` (metrics CSV with Speed=N/A)

#### Batch Processing
```bash
python batch_v17_analysis.py
# or for single folder:
python test_batch_v17.py "FolderName"
```
**Output for each folder**:
- Individual layer plots (one per autolog file)
- `autolog_metrics.csv` (combined metrics for all layers with speeds from instruction file)
- `batch_results_YYYYMMDD_HHMMSS.csv` (summary CSV of all folders)

### 5. Validation Results

**Test File**: `autolog_L330-L334.csv` (5 layers)

**Sample Output**:
```
Layer  Speed      Peak    WoA     Prop_Dist  Prop_Time
330    N/A        0.289N  0.439mJ  1.072mm    0.113s
331    N/A        0.332N  0.385mJ  0.773mm    0.081s
332    N/A        0.297N  0.332mJ  0.761mm    0.080s
333    N/A        0.323N  0.416mJ  0.871mm    0.092s
334    N/A        0.296N  0.478mJ  1.049mm    0.110s
```

**Test Folder**: `2p5PEO_1mm_Ramped_BPAGDA_Old`

**Sample Output** (with speeds):
```
Layer  Speed       Peak    WoA     Prop_Dist  Prop_Time
110    2073.7µm/s  0.200N  0.220mJ  0.690mm    0.334s
111    2073.7µm/s  0.208N  0.266mJ  3.115mm    1.502s
112    2073.7µm/s  0.230N  0.198mJ  0.434mm    0.210s
113    2073.7µm/s  0.270N  0.248mJ  0.464mm    0.223s
114    2073.7µm/s  0.205N  0.249mJ  3.380mm    1.507s
```

Note the significant variation in propagation metrics between layers - this demonstrates that the metrics are correctly calculated (peak to propagation end), not using a fixed lift distance.

## Advantages Over Original Implementation

1. **Correct Propagation Metrics**: Measures actual crack propagation phase, not entire lift motion
2. **Speed Integration**: Includes step speed from instruction file for correlation analysis
3. **Batch Processing**: Automatically generates CSV for entire test folders
4. **Consistent Format**: Matches live PeakForceLogger output for easy comparison
5. **All Layers**: Processes all layers in file (not limited to first 3)
6. **Actual Layer Numbers**: Uses real layer numbers from filename (e.g., 330-334, not 1-5)

## Future Enhancements

- [ ] Add retraction force analysis
- [ ] Include derivative metrics in CSV
- [ ] Add timestamp column for tracking when analysis was performed
- [ ] Support for merging multiple autolog_metrics.csv files across folders
